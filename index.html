<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Textil Cloud - Cirineo v3.2</title>
    
    <link id="appIcon" rel="icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    <link id="appAppleIcon" rel="apple-touch-icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    <meta name="theme-color" content="#1e293b">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Oswald:wght@400;500;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .font-oswald { font-family: 'Oswald', sans-serif; }
        .font-condensed { font-family: 'Roboto Condensed', sans-serif; }
        
        .card-hover { transition: all 0.2s; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .input-std { @apply w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- CONFIGURACIÓN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- COMPONENTES UI ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (lucide.icons[name] && iconRef.current) {
                    lucide.createIcons({
                        icons: { [name]: lucide.icons[name] },
                        nameAttr: 'data-lucide',
                        attrs: { class: className, width: size, height: size }
                    });
                    const svg = iconRef.current.querySelector('svg');
                    if(svg) iconRef.current.replaceWith(svg);
                }
            }, [name, size, className]);
            return <i ref={iconRef} data-lucide={name} className={className}></i>;
        };

        const StatCard = ({ title, value, color, icon }) => (
            <div className={`bg-white p-4 rounded-xl border-l-4 ${color} shadow-sm flex items-center justify-between`}>
                <div>
                    <p className="text-xs font-bold text-slate-400 uppercase tracking-wider">{title}</p>
                    <p className="text-2xl font-black text-slate-800 font-oswald">{value}</p>
                </div>
                <div className={`p-3 rounded-full bg-opacity-10 ${color.replace('border-', 'bg-').replace('500', '500')}`}>
                    <Icon name={icon} className={color.replace('border-', 'text-')} />
                </div>
            </div>
        );

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col animate-in zoom-in-95 duration-200">
                        <div className="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 className="text-xl font-bold text-slate-800 font-oswald flex items-center gap-2">
                                {title}
                            </h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full text-slate-500 transition-colors">
                                <Icon name="x" size={24} />
                            </button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const DashboardBottom = ({ activeOrders }) => {
            // Cálculos rápidos de métricas generales
            const totalPending = activeOrders.reduce((acc, order) => {
                const total = order.totalPedido || 0;
                // Calculamos cuántos paquetes están finished: true
                const finishedCount = order.packages ? order.packages.filter(p => p.finished).length : 0;
                const pSize = parseInt(order.packageSize) || 50;
                
                // Estimación de piezas hechas
                const made = finishedCount * pSize;
                return acc + (total - made > 0 ? total - made : 0);
            }, 0);

            const uniqueMachines = [...new Set(activeOrders.map(o => o.maquina).filter(Boolean))].length;

            return (
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
                    <div className="bg-slate-800 text-white p-4 rounded-xl flex items-center gap-4 shadow-lg">
                        <div className="p-3 bg-blue-500 rounded-lg"><Icon name="activity" /></div>
                        <div>
                            <div className="text-xs text-slate-400 font-bold uppercase">Órdenes Activas</div>
                            <div className="text-2xl font-bold font-oswald">{activeOrders.length}</div>
                        </div>
                    </div>
                    <div className="bg-slate-800 text-white p-4 rounded-xl flex items-center gap-4 shadow-lg">
                        <div className="p-3 bg-yellow-500 rounded-lg text-black"><Icon name="layers" /></div>
                        <div>
                            <div className="text-xs text-slate-400 font-bold uppercase">Piezas Pendientes</div>
                            <div className="text-2xl font-bold font-oswald">{totalPending.toLocaleString()}</div>
                        </div>
                    </div>
                    <div className="bg-slate-800 text-white p-4 rounded-xl flex items-center gap-4 shadow-lg">
                        <div className="p-3 bg-purple-500 rounded-lg"><Icon name="cpu" /></div>
                        <div>
                            <div className="text-xs text-slate-400 font-bold uppercase">Máquinas en Uso</div>
                            <div className="text-2xl font-bold font-oswald">{uniqueMachines}</div>
                        </div>
                    </div>
                    <div className="bg-slate-800 text-white p-4 rounded-xl flex items-center justify-center gap-2 shadow-lg cursor-pointer hover:bg-slate-700 transition" onClick={() => window.open('Generador de papeletas.html', '_blank')}>
                         <Icon name="printer" /> 
                         <span className="font-bold">IR A IMPRESIÓN</span>
                    </div>
                </div>
            );
        };

        // --- APLICACIÓN PRINCIPAL ---
        const App = () => {
            const [orders, setOrders] = useState([]);
            const [loading, setLoading] = useState(true);
            const [viewMode, setViewMode] = useState('active'); // 'active' | 'history'
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isEditMode, setIsEditMode] = useState(false);
            const [currentOrder, setCurrentOrder] = useState(null);
            
            // Filtros
            const [searchTerm, setSearchTerm] = useState('');
            const [machineFilter, setMachineFilter] = useState('');

            // Formulario
            const [formData, setFormData] = useState({
                codigo: '', cliente: '', partida: '', maquina: '',
                totalPedido: '', packageSize: '50',
                threading: [{material: '', kilos: ''}, {material: '', kilos: ''}],
                subPiecesData: [{pieza: '', talla: '', peso: '', tiempo: ''}]
            });

            // Cargar datos
            useEffect(() => {
                const unsubscribe = db.collection('orders').onSnapshot(snapshot => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Ordenar: Recientes primero
                    data.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    setOrders(data);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // Manejo del formulario
            const resetForm = () => {
                setFormData({
                    codigo: '', cliente: '', partida: '', maquina: '',
                    totalPedido: '', packageSize: '50',
                    threading: [{material: '', kilos: ''}, {material: '', kilos: ''}],
                    subPiecesData: [{pieza: '', talla: '', peso: '', tiempo: ''}]
                });
                setIsEditMode(false);
                setCurrentOrder(null);
            };

            const openNewOrder = () => { resetForm(); setIsModalOpen(true); };
            
            const openEditOrder = (order) => {
                setFormData({
                    codigo: order.codigo || '',
                    cliente: order.cliente || '',
                    partida: order.partida || '',
                    maquina: order.maquina || '',
                    totalPedido: order.totalPedido || '',
                    packageSize: order.packageSize || '50',
                    threading: order.threading || [{material: '', kilos: ''}, {material: '', kilos: ''}],
                    subPiecesData: order.subPiecesData || [{pieza: '', talla: '', peso: '', tiempo: ''}]
                });
                setCurrentOrder(order);
                setIsEditMode(true);
                setIsModalOpen(true);
            };

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleArrayChange = (arrayName, index, field, value) => {
                const newArray = [...formData[arrayName]];
                newArray[index] = { ...newArray[index], [field]: value };
                setFormData(prev => ({ ...prev, [arrayName]: newArray }));
            };

            // --- LÓGICA CORE: GUARDAR/ACTUALIZAR ---
            const handleSaveOrder = async (e) => {
                e.preventDefault();
                
                if (!formData.codigo || !formData.totalPedido) return alert("Código y Total requeridos");

                try {
                    // 1. CALCULAR PAQUETES Y GENERAR ARRAY ESTRUCTURADO PARA EL ESCÁNER
                    // Esto es crucial para que "finished: true" funcione.
                    const qty = parseInt(formData.totalPedido) || 0;
                    const pSize = parseInt(formData.packageSize) || 50;
                    const numPackages = Math.ceil(qty / pSize);
                    
                    // Generamos el array de paquetes.
                    // IMPORTANTE: Si estamos editando, intentamos preservar los que ya estaban marcados como finished
                    let packagesArray = [];
                    
                    if (isEditMode && currentOrder && currentOrder.packages) {
                        // Lógica compleja de merge si se edita cantidad (simplificada: regeneramos si cambia total, o mantenemos)
                        // Para seguridad en producción simple: Si cambia el total drásticamente, mejor regenerar o advertir.
                        // Aquí, regeneramos estructura preservando estado si el índice coincide, para simpleza:
                        for(let i=0; i < numPackages; i++) {
                            const existing = currentOrder.packages.find(p => p.index === i);
                            packagesArray.push({
                                index: i,
                                finished: existing ? existing.finished : false, // MANTENER ESTADO
                                timestamp: existing ? existing.timestamp : null,
                                weaver: existing ? existing.weaver : null
                            });
                        }
                    } else {
                        // MODO CREACIÓN: Generar desde cero limpios
                        for(let i=0; i < numPackages; i++) {
                            packagesArray.push({
                                index: i,
                                finished: false, // ESTADO INICIAL FALSO
                                timestamp: null,
                                weaver: null
                            });
                        }
                    }

                    const payload = {
                        ...formData,
                        totalPedido: parseInt(formData.totalPedido),
                        // Guardamos el array de paquetes explícitamente
                        packages: packagesArray,
                        updatedAt: new Date().getTime()
                    };

                    if (isEditMode && currentOrder) {
                        await db.collection('orders').doc(String(currentOrder.id)).update(payload);
                    } else {
                        // Usar timestamp como ID para asegurar orden numérico descendente simple
                        const newId = new Date().getTime(); 
                        await db.collection('orders').doc(String(newId)).set({
                            ...payload,
                            id: newId,
                            status: 'PENDIENTE',
                            createdAt: newId
                        });
                    }

                    setIsModalOpen(false);
                    resetForm();

                } catch (error) {
                    console.error(error);
                    alert("Error guardando: " + error.message);
                }
            };

            const handleDelete = async (id) => {
                if(confirm("¿Eliminar esta orden permanentemente?")) {
                    await db.collection('orders').doc(String(id)).delete();
                }
            };

            // Filtrado para visualización
            const displayedOrders = useMemo(() => {
                let filtered = orders;
                
                // Filtro Estado
                if (viewMode === 'active') {
                    filtered = filtered.filter(o => o.status !== 'ARCHIVADO');
                } else {
                    filtered = filtered.filter(o => o.status === 'ARCHIVADO');
                }

                // Filtro Texto
                if (searchTerm) {
                    const lower = searchTerm.toLowerCase();
                    filtered = filtered.filter(o => 
                        o.codigo?.toLowerCase().includes(lower) || 
                        o.cliente?.toLowerCase().includes(lower) ||
                        o.partida?.toLowerCase().includes(lower)
                    );
                }

                // Filtro Maquina
                if (machineFilter) {
                    filtered = filtered.filter(o => o.maquina == machineFilter);
                }

                return filtered;
            }, [orders, viewMode, searchTerm, machineFilter]);


            return (
                <div className="min-h-screen pb-20">
                    {/* Header */}
                    <div className="bg-slate-900 text-white shadow-lg sticky top-0 z-30">
                        <div className="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 p-2 rounded-lg">
                                    <Icon name="layout-grid" className="text-white" />
                                </div>
                                <div>
                                    <h1 className="font-oswald text-xl tracking-wide font-bold">CIRINEO <span className="text-blue-400">PRO</span></h1>
                                    <p className="text-[10px] text-slate-400 tracking-wider">CONTROL DE PRODUCCIÓN</p>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button 
                                    onClick={() => setViewMode(viewMode === 'active' ? 'history' : 'active')}
                                    className={`px-4 py-2 rounded-lg text-xs font-bold transition flex items-center gap-2 ${viewMode === 'history' ? 'bg-yellow-500 text-black' : 'bg-slate-800 text-slate-300 hover:bg-slate-700'}`}
                                >
                                    <Icon name={viewMode === 'active' ? 'history' : 'activity'} size={16} />
                                    {viewMode === 'active' ? 'VER HISTORIAL' : 'VER ACTIVAS'}
                                </button>
                                <button 
                                    onClick={openNewOrder}
                                    className="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-xs font-bold transition flex items-center gap-2 shadow-lg shadow-blue-900/50"
                                >
                                    <Icon name="plus-circle" size={16} />
                                    NUEVA ORDEN
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 mt-6">
                        
                        {/* Controles de Filtro */}
                        <div className="bg-white p-4 rounded-xl shadow-sm mb-6 flex flex-wrap gap-4 items-center">
                            <div className="relative flex-grow max-w-md">
                                <Icon name="search" size={18} className="absolute left-3 top-3 text-slate-400" />
                                <input 
                                    type="text" 
                                    placeholder="Buscar por código, cliente, partida..." 
                                    value={searchTerm}
                                    onChange={e => setSearchTerm(e.target.value)}
                                    className="w-full pl-10 pr-4 py-2 bg-slate-100 border-none rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                                />
                            </div>
                            <select 
                                value={machineFilter} 
                                onChange={e => setMachineFilter(e.target.value)}
                                className="bg-slate-100 border-none rounded-lg py-2 px-4 text-sm focus:ring-2 focus:ring-blue-500 text-slate-700 font-bold"
                            >
                                <option value="">TODAS LAS MÁQUINAS</option>
                                {[...new Set(orders.map(o => o.maquina).filter(Boolean))].sort().map(m => (
                                    <option key={m} value={m}>MÁQUINA {m}</option>
                                ))}
                            </select>
                        </div>

                        {/* Modal Formulario */}
                        <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={isEditMode ? "EDITAR ORDEN" : "NUEVA ORDEN DE PRODUCCIÓN"}>
                            <form onSubmit={handleSaveOrder} className="space-y-6">
                                <div className="grid grid-cols-12 gap-4">
                                    {/* Columna Izq - Datos Principales */}
                                    <div className="col-span-12 md:col-span-8 space-y-4">
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 mb-1">CÓDIGO / MODELO</label>
                                                <input required name="codigo" value={formData.codigo} onChange={handleInputChange} className="w-full bg-slate-50 border border-slate-300 rounded p-2 focus:border-blue-500 font-oswald text-lg" placeholder="Ej. 7015" />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 mb-1">PARTIDA</label>
                                                <input name="partida" value={formData.partida} onChange={handleInputChange} className="w-full bg-slate-50 border border-slate-300 rounded p-2 focus:border-blue-500 font-bold" placeholder="Ej. 520" />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">CLIENTE</label>
                                            <input name="cliente" value={formData.cliente} onChange={handleInputChange} className="w-full bg-slate-50 border border-slate-300 rounded p-2 focus:border-blue-500" placeholder="Nombre del cliente" />
                                        </div>
                                        <div className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                                            <h4 className="text-xs font-bold text-slate-400 mb-3 flex items-center gap-2"><Icon name="settings-2" size={14}/> DETALLES TÉCNICOS</h4>
                                            <div className="grid grid-cols-3 gap-3">
                                                <div>
                                                    <label className="block text-[10px] font-bold text-slate-500">PIEZA</label>
                                                    <input value={formData.subPiecesData[0].pieza} onChange={(e) => handleArrayChange('subPiecesData', 0, 'pieza', e.target.value)} className="w-full border rounded p-1 text-sm" placeholder="Ej. BOXER" />
                                                </div>
                                                <div>
                                                    <label className="block text-[10px] font-bold text-slate-500">TALLA</label>
                                                    <input value={formData.subPiecesData[0].talla} onChange={(e) => handleArrayChange('subPiecesData', 0, 'talla', e.target.value)} className="w-full border rounded p-1 text-sm" placeholder="Ej. CH-MD" />
                                                </div>
                                                <div>
                                                    <label className="block text-[10px] font-bold text-slate-500">TIEMPO (min)</label>
                                                    <input type="number" value={formData.subPiecesData[0].tiempo} onChange={(e) => handleArrayChange('subPiecesData', 0, 'tiempo', e.target.value)} className="w-full border rounded p-1 text-sm" placeholder="0.0" />
                                                </div>
                                            </div>
                                            <div className="mt-3 grid grid-cols-2 gap-3">
                                                <div>
                                                     <label className="block text-[10px] font-bold text-slate-500">MATERIAL 1 (NYLON)</label>
                                                     <input value={formData.threading[0].material} onChange={(e) => handleArrayChange('threading', 0, 'material', e.target.value)} className="w-full border rounded p-1 text-sm" placeholder="Desc material 1" />
                                                </div>
                                                <div>
                                                     <label className="block text-[10px] font-bold text-slate-500">MATERIAL 2 (LYCRA)</label>
                                                     <input value={formData.threading[1].material} onChange={(e) => handleArrayChange('threading', 1, 'material', e.target.value)} className="w-full border rounded p-1 text-sm" placeholder="Desc material 2" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Columna Der - Producción */}
                                    <div className="col-span-12 md:col-span-4 space-y-4">
                                        <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                            <label className="block text-xs font-bold text-blue-800 mb-1">TOTAL A PRODUCIR</label>
                                            <input type="number" required name="totalPedido" value={formData.totalPedido} onChange={handleInputChange} className="w-full bg-white border-2 border-blue-200 rounded p-2 text-2xl font-black text-blue-900 focus:outline-none focus:border-blue-500 text-center" placeholder="0" />
                                        </div>
                                        <div className="bg-yellow-50 p-4 rounded-xl border border-yellow-100">
                                            <label className="block text-xs font-bold text-yellow-800 mb-1">TAMAÑO PAQUETE</label>
                                            <input type="number" name="packageSize" value={formData.packageSize} onChange={handleInputChange} className="w-full bg-white border-2 border-yellow-200 rounded p-2 text-xl font-bold text-yellow-900 focus:outline-none focus:border-yellow-500 text-center" placeholder="50" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">MÁQUINA ASIGNADA</label>
                                            <input name="maquina" value={formData.maquina} onChange={handleInputChange} className="w-full bg-slate-50 border border-slate-300 rounded p-2 text-center font-bold" placeholder="#" />
                                        </div>
                                    </div>
                                </div>
                                <div className="pt-4 border-t flex justify-end gap-3">
                                    <button type="button" onClick={() => setIsModalOpen(false)} className="px-5 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg">CANCELAR</button>
                                    <button type="submit" className="px-8 py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-lg shadow-blue-500/30 flex items-center gap-2">
                                        <Icon name="save" size={18} />
                                        {isEditMode ? 'ACTUALIZAR ORDEN' : 'CREAR ORDEN'}
                                    </button>
                                </div>
                            </form>
                        </Modal>

                        {/* LISTADO DE TARJETAS */}
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            {displayedOrders.map(order => {
                                // Calculamos progreso visual
                                const total = order.totalPedido || 1;
                                const finishedPkgs = order.packages ? order.packages.filter(p => p.finished).length : 0;
                                const pSize = parseInt(order.packageSize) || 50;
                                const doneApprox = finishedPkgs * pSize;
                                const pct = Math.min(100, Math.round((doneApprox / total) * 100));

                                return (
                                    <div key={order.id} className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden card-hover flex flex-col h-full relative group">
                                        
                                        {/* Barra de estado lateral */}
                                        <div className={`absolute left-0 top-0 bottom-0 w-1 ${order.status === 'ARCHIVADO' ? 'bg-slate-400' : (pct >= 100 ? 'bg-green-500' : 'bg-blue-500')}`}></div>

                                        <div className="p-4 flex-grow">
                                            <div className="flex justify-between items-start mb-2">
                                                <span className="font-oswald text-2xl font-bold text-slate-800 leading-none">{order.codigo}</span>
                                                <div className="flex flex-col items-end">
                                                    <span className="bg-slate-100 text-slate-600 px-2 py-0.5 rounded text-[10px] font-bold tracking-wider mb-1">{order.partida}</span>
                                                    <span className="text-[10px] text-slate-400">MQ-{order.maquina}</span>
                                                </div>
                                            </div>
                                            <p className="text-sm text-slate-500 font-medium truncate mb-4">{order.cliente || 'Sin cliente'}</p>
                                            
                                            {/* Barra de progreso */}
                                            <div className="mb-2">
                                                <div className="flex justify-between text-xs mb-1 font-bold">
                                                    <span className={pct >= 100 ? "text-green-600" : "text-blue-600"}>{pct}% Completado</span>
                                                    <span className="text-slate-400">{doneApprox}/{total}</span>
                                                </div>
                                                <div className="w-full bg-slate-100 rounded-full h-2 overflow-hidden">
                                                    <div className={`h-full rounded-full transition-all duration-500 ${pct >= 100 ? 'bg-green-500' : 'bg-blue-500'}`} style={{width: `${pct}%`}}></div>
                                                </div>
                                            </div>
                                            
                                            <div className="grid grid-cols-2 gap-2 mt-4 text-xs text-slate-500 border-t pt-3">
                                                <div>
                                                    <span className="block font-bold text-slate-400 text-[10px]">PAQUETES</span>
                                                    <span className="font-mono text-slate-700">{finishedPkgs} / {order.packages ? order.packages.length : Math.ceil(total/pSize)}</span>
                                                </div>
                                                <div className="text-right">
                                                    <span className="block font-bold text-slate-400 text-[10px]">TALLA</span>
                                                    <span className="text-slate-700">{order.subPiecesData?.[0]?.talla || '-'}</span>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Acciones */}
                                        <div className="bg-slate-50 p-3 border-t border-slate-100 flex justify-between items-center opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button onClick={() => openEditOrder(order)} className="text-blue-600 hover:text-blue-700 font-bold text-xs flex items-center gap-1">
                                                <Icon name="edit-2" size={14} /> EDITAR
                                            </button>
                                            <button onClick={() => handleDelete(order.id)} className="text-red-400 hover:text-red-600">
                                                <Icon name="trash-2" size={16} />
                                            </button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        
                        {/* Footer info */}
                        {viewMode === 'active' && <DashboardBottom activeOrders={displayedOrders} />}
                        {viewMode === 'history' && (
                            <div className="mt-8 p-10 bg-slate-100 rounded-xl text-center text-slate-400">
                                <Icon name="archive" size={48} className="mx-auto mb-4 opacity-20" />
                                <p className="font-bold">Mostrando historial de órdenes archivadas</p>
                            </div>
                        )}
                        
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
