<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Textil Cloud - Cirineo v3.1</title>
    
    <link id="appIcon" rel="icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    <link id="appAppleIcon" rel="apple-touch-icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    <meta name="theme-color" content="#1e293b">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap');
        body { font-family: 'Roboto', sans-serif; }
    </style>
</head>
<body class="bg-slate-900 text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        // --- Configuración de Firebase ---
        const firebaseConfig = {
            apiKey: "TU_API_KEY", // Reemplaza con tu API Key
            authDomain: "TU_AUTH_DOMAIN", // Reemplaza con tu dominio
            projectId: "TU_PROJECT_ID", // Reemplaza con tu Project ID
        };
        
        // Inicializar Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // --- Componentes y Hooks ---

        // Iconos de Lucide
        const Icon = ({ name, size = 24, className = "" }) => {
            const [iconHtml, setIconHtml] = useState(null);
            
            useEffect(() => {
                const iconFn = lucide.icons[name];
                if (iconFn) {
                    const attributes = {
                        width: size,
                        height: size,
                        class: className,
                        stroke: "currentColor",
                        strokeWidth: "2",
                        strokeLinecap: "round",
                        strokeLinejoin: "round",
                    };
                    setIconHtml(iconFn(attributes));
                }
            }, [name, size, className]);

            if (!iconHtml) return null;
            return <div dangerouslySetInnerHTML={{ __html: iconHtml }} />;
        };

        // Hook para Escáner de Código de Barras (simula un escáner real)
        const useBarcodeScanner = (callback) => {
            useEffect(() => {
                let barcode = '';
                let lastKeypressTime = 0;
                const TIMEOUT = 100; // Máximo de 100ms entre teclas para considerarlo un escaneo

                const handleKeyPress = (e) => {
                    const currentTime = new Date().getTime();
                    
                    // Si ha pasado demasiado tiempo, reinicia el buffer del código
                    if (currentTime - lastKeypressTime > TIMEOUT) {
                        barcode = '';
                    }

                    // Ignorar teclas modificadoras o especiales
                    if (e.key.length !== 1 && e.key !== 'Enter') {
                        lastKeypressTime = currentTime;
                        return;
                    }

                    if (e.key === 'Enter') {
                        // Enter finaliza el escaneo
                        e.preventDefault(); // Evita que el Enter haga cosas inesperadas
                        if (barcode.length > 0) {
                            console.log("Escaneo detectado:", barcode);
                            callback(barcode);
                        }
                        barcode = ''; // Reinicia el buffer
                    } else {
                        // Agrega el carácter al buffer
                        barcode += e.key;
                    }
                    
                    lastKeypressTime = currentTime;
                };

                document.addEventListener('keypress', handleKeyPress);
                return () => {
                    document.removeEventListener('keypress', handleKeyPress);
                };
            }, [callback]);
        };

        // Componente para visualizar el progreso de un paquete
        const PackageTicket = ({ pkg, orderId }) => {
            // El ID del paquete escaneable es: ORDERID-PACKAGEID
            const barcodeValue = `${orderId}-${pkg.id}`;
            const svgRef = React.useRef(null);
            const isFinished = pkg.finished || false;

            useEffect(() => {
                if (svgRef.current && barcodeValue) {
                    try {
                        // Generar código de barras (CODE128)
                        JsBarcode(svgRef.current, barcodeValue, {
                            format: "CODE128",
                            lineColor: "#000",
                            width: 1.5,
                            height: 30,
                            displayValue: false,
                            margin: 2
                        });
                    } catch (e) {
                        console.error("Error al generar código de barras para el paquete", e);
                    }
                }
            }, [barcodeValue]);
            
            const totalCajas = pkg.totalCajas || 1; // Fallback
            const fechaTerminado = pkg.fechaTerminado ? pkg.fechaTerminado.toDate().toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' }) : 'N/A';

            return (
                <div className={`p-2 rounded-lg shadow-md transition-all duration-300 ${isFinished ? 'bg-green-700 hover:bg-green-600' : 'bg-slate-600 hover:bg-slate-500'}`}>
                    <div className="flex justify-between items-start mb-1">
                        <div className="font-extrabold text-sm flex items-center">
                            <Icon name={isFinished ? "check-circle" : "package"} size={16} className={`mr-1 ${isFinished ? 'text-green-300' : 'text-yellow-400'}`} />
                            Paquete: {pkg.codigoUnico} 
                        </div>
                        <div className="text-xs font-bold text-slate-300">Caja {pkg.cajaIndex} de {totalCajas}</div>
                    </div>
                    
                    <div className="grid grid-cols-3 gap-2 text-center text-[10px] my-1">
                        <div><span className="font-bold">Total Pzs:</span> {pkg.totalPzs}</div>
                        <div><span className="font-bold">Tipo:</span> {pkg.tipo}</div>
                        <div><span className="font-bold">ID:</span> {pkg.id}</div>
                    </div>

                    <div className="flex justify-center items-center h-10 w-full bg-white rounded my-2 border border-slate-300">
                         {/* Barcode SVG */}
                         <svg ref={svgRef} className="w-full h-full"></svg>
                    </div>

                    {isFinished ? (
                        <div className="text-center text-xs font-bold text-green-300">
                            TERMINADO {fechaTerminado} ({pkg.tejedor})
                        </div>
                    ) : (
                        <div className="text-center text-xs font-bold text-yellow-400">
                            PENDIENTE POR ESCANEAR
                        </div>
                    )}
                </div>
            );
        };

        // Componente de Dashboard para órdenes activas
        const DashboardBottom = ({ activeOrders }) => {
            return (
                <div className="p-6 bg-slate-800 border-t border-slate-700">
                    <h2 className="text-xl font-bold mb-4 text-indigo-400 flex items-center">
                        <Icon name="boxes" size={24} className="mr-2" />
                        Detalle de Paquetes
                    </h2>
                    
                    <div className="space-y-6 max-h-[40vh] overflow-y-auto pr-2">
                        {activeOrders.map(order => (
                            <div key={order.id} className="bg-slate-700 p-4 rounded-lg shadow-xl">
                                <div className="text-sm font-bold border-b border-slate-600 pb-2 mb-3">
                                    <span className="text-yellow-400">{order.cliente}</span> - Pedido: {order.noPedido} - {order.modelo} ({order.color})
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                                    {order.progreso && order.progreso.map(pkg => (
                                        <PackageTicket key={pkg.id} pkg={pkg} orderId={order.id} />
                                    ))}
                                    {!order.progreso && <div className="col-span-full text-center text-slate-400 py-4">No hay paquetes definidos para esta orden.</div>}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // Componente Principal de la Aplicación (Maneja la Conexión y el Escaneo)
        const App = () => {
            const [orders, setOrders] = useState([]);
            const [loading, setLoading] = useState(true);
            const [viewMode, setViewMode] = useState('active'); // 'active' o 'history'
            const [searchTerm, setSearchTerm] = useState('');

            // Fetch de Órdenes desde Firebase
            useEffect(() => {
                const collectionRef = db.collection('orders');
                
                let query = collectionRef.orderBy('fechaPedido', 'desc');

                // Filtra solo por órdenes activas/en proceso para la vista por defecto
                if (viewMode === 'active') {
                    query = query.where('status', 'in', ['PENDIENTE', 'EN PROCESO']);
                } else if (viewMode === 'history') {
                    query = query.where('status', '==', 'ARCHIVADO').limit(50); // Limita el historial
                }

                const unsubscribe = query.onSnapshot(snapshot => {
                    const fetchedOrders = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setOrders(fetchedOrders);
                    setLoading(false);
                }, error => {
                    console.error("Error al obtener órdenes:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [viewMode]);

            // Lógica para el escaneo global
            const handleGlobalScan = useCallback(async (scannedCode) => {
                // Formato esperado: "ORDERID-PKGID"
                if (!scannedCode.includes('-')) {
                    console.warn("Código escaneado no tiene el formato esperado (ORDERID-PKGID):", scannedCode);
                    return;
                }
                
                const [orderId, pkgIdString] = scannedCode.split('-');
                
                // Asegurar que pkgId sea un número para la búsqueda
                const pkgId = parseFloat(pkgIdString); 
                
                const targetOrder = orders.find(o => String(o.id) === orderId);

                if (targetOrder) {
                    const targetPkg = targetOrder.progreso.find(p => p.id === pkgId);
                    
                    if (targetPkg) {
                        if (targetPkg.finished) {
                            alert(`El paquete ${targetPkg.codigoUnico} ya estaba marcado como terminado.`);
                            return;
                        }
                        
                        // 1. Crear el nuevo progreso con el paquete actualizado
                        const newProgreso = targetOrder.progreso.map(p => 
                            p.id === pkgId 
                                ? { 
                                    ...p, 
                                    finished: true, 
                                    tejedor: 'ESCÁNER', // Puedes reemplazar con el nombre de usuario autenticado
                                    fechaTerminado: firebase.firestore.FieldValue.serverTimestamp() 
                                } 
                                : p
                        );
                        
                        // 2. Revisar si todos los paquetes están terminados para actualizar el estado de la orden
                        const isOrderFinished = newProgreso.every(p => p.finished);
                        
                        const updateData = { progreso: newProgreso };
                        if (isOrderFinished) {
                            updateData.status = 'TERMINADO';
                            updateData.fechaTerminado = firebase.firestore.FieldValue.serverTimestamp();
                        }
                        
                        // 3. Actualizar en Firebase
                        try {
                            await db.collection('orders').doc(String(orderId)).update(updateData);
                            alert(`✅ Paquete ${targetPkg.codigoUnico} marcado como terminado. ${isOrderFinished ? '¡Orden completa!' : ''}`);
                        } catch (error) {
                            console.error("Error al actualizar Firebase:", error);
                            alert("❌ Error al guardar el progreso en la base de datos.");
                        }

                    } else {
                        alert(`❌ Paquete con ID ${pkgIdString} no encontrado en la orden ${orderId}.`);
                    }
                } else {
                    alert(`❌ Orden con ID ${orderId} no encontrada.`);
                }
            }, [orders]);

            // Activar el hook de escaneo global
            useBarcodeScanner(handleGlobalScan);

            // Filtro de Órdenes
            const displayedOrders = useMemo(() => {
                if (!searchTerm) return orders;
                const term = searchTerm.toLowerCase();
                return orders.filter(o => 
                    o.cliente.toLowerCase().includes(term) ||
                    String(o.id).includes(term) ||
                    String(o.noPedido).includes(term) ||
                    o.modelo.toLowerCase().includes(term)
                );
            }, [orders, searchTerm]);

            // Formato de Fechas
            const formatTimestamp = (timestamp) => {
                if (!timestamp) return 'N/A';
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleDateString('es-MX', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric' 
                });
            };

            return (
                <div className="flex flex-col h-screen">
                    {/* Header y Filtros */}
                    <div className="bg-slate-900 border-b border-slate-700 p-4 shadow-2xl flex flex-col md:flex-row justify-between items-center sticky top-0 z-10">
                        <h1 className="text-3xl font-extrabold text-indigo-400 mb-4 md:mb-0 flex items-center">
                            <Icon name="zap" size={28} className="mr-2 text-yellow-400" />
                            SISTEMA SANTONI
                        </h1>

                        <div className="flex space-x-4">
                             {/* Selector de Vista */}
                            <div className="bg-slate-700 p-1 rounded-lg flex">
                                <button
                                    onClick={() => setViewMode('active')}
                                    className={`px-4 py-2 text-sm font-bold rounded-md transition-colors ${viewMode === 'active' ? 'bg-indigo-600 text-white shadow' : 'text-slate-300 hover:bg-slate-600'}`}
                                >
                                    Órdenes Activas
                                </button>
                                <button
                                    onClick={() => setViewMode('history')}
                                    className={`px-4 py-2 text-sm font-bold rounded-md transition-colors ${viewMode === 'history' ? 'bg-indigo-600 text-white shadow' : 'text-slate-300 hover:bg-slate-600'}`}
                                >
                                    Historial
                                </button>
                            </div>
                            
                            {/* Búsqueda */}
                            <div className="relative">
                                <input
                                    type="text"
                                    placeholder="Buscar (Cliente, Pedido, ID...)"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="bg-slate-700 text-white p-2 pl-10 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none w-full md:w-64"
                                />
                                <Icon name="search" size={20} className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" />
                            </div>
                        </div>
                    </div>

                    {/* Contenido Principal */}
                    <div className="flex-grow overflow-y-auto">
                        
                        <div className="p-6">
                            <h2 className="text-2xl font-bold mb-4 text-slate-300 flex items-center">
                                <Icon name="list-checks" size={24} className="mr-2" />
                                Lista de Órdenes ({viewMode === 'active' ? 'EN PRODUCCIÓN' : 'HISTORIAL'})
                            </h2>
                            
                            {loading ? (
                                <div className="text-center py-20 text-indigo-400 font-bold text-xl">
                                    <Icon name="loader" size={32} className="animate-spin mx-auto mb-4" />
                                    Cargando órdenes...
                                </div>
                            ) : (
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                    {displayedOrders.map(o => {
                                        const totalFinished = o.progreso ? o.progreso.filter(p => p.finished).length : 0;
                                        const totalPackages = o.progreso ? o.progreso.length : 1;
                                        const pct = totalPackages > 0 ? (totalFinished / totalPackages) * 100 : 0;
                                        
                                        return (
                                            <div key={o.id} className="bg-slate-700 p-4 rounded-xl shadow-lg hover:shadow-2xl hover:ring-2 ring-indigo-500 transition-all duration-300">
                                                <div className="text-xs text-indigo-400 font-bold mb-1">ID: {o.id}</div>
                                                <h3 className="text-xl font-extrabold text-white mb-1">{o.cliente}</h3>
                                                <div className="text-sm text-slate-300">{o.modelo} - {o.color}</div>
                                                <div className="text-sm text-slate-400 mt-2">Pedido: {o.noPedido}</div>
                                                <div className="text-sm text-slate-400">Fecha Entrega: {formatTimestamp(o.fechaEntrega)}</div>
                                                
                                                <div className="mt-3 border-t border-slate-600 pt-3">
                                                    <div className="text-sm font-bold flex justify-between items-center">
                                                        <span>Paquetes Terminados:</span>
                                                        <span className={`${pct === 100 ? 'text-green-400' : 'text-yellow-400'} text-lg`}>{totalFinished}/{totalPackages}</span>
                                                    </div>
                                                </div>
                                                
                                                <div className="text-[10px] text-slate-400">Total: {o.totalPedido} pzs</div>
                                                <div className="mt-2 w-full bg-slate-100 h-2 rounded overflow-hidden">
                                                    <div className={`${o.status === 'ARCHIVADO' ? 'bg-slate-500' : 'bg-green-500'} h-full`} style={{width:`${pct}%`}}></div>
                                                </div>
                                                {o.status === 'ARCHIVADO' && <div className="text-center text-[10px] font-bold text-slate-500 mt-1">ARCHIVADO</div>}
                                            </div>
                                        );
                                    })
                                }
                                {displayedOrders.length === 0 && <div className="col-span-4 text-center text-slate-400 py-10 font-bold">No hay órdenes en esta vista.</div>}
                            </div>
                        </div>
                        
                        {viewMode === 'active' && <DashboardBottom activeOrders={displayedOrders} />}
                        {viewMode === 'history' && <div className="bg-slate-800 text-white flex items-center justify-center p-10 font-bold text-xl opacity-50">MODO HISTORIAL - SOLO LECTURA</div>}
                        
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
