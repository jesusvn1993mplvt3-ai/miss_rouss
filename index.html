<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Textil Cloud - Cirineo</title>
    
    <link id="appIcon" rel="icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    <link id="appAppleIcon" rel="apple-touch-icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    <meta name="theme-color" content="#1e293b">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>

    <style>
        @media print {
            /* Ocultar todo lo que no es la papeleta */
            #root, .no-print {
                display: none !important;
            }

            /* Mostrar solo el contenedor de impresión */
            .print-label-view {
                display: block !important;
            }

            /* Configuración de la página/papeleta 4" x 6" (10.16cm x 15.24cm) */
            .label-page {
                page-break-after: always;
                width: 15.24cm;  /* 6 inches */
                height: 10.16cm; /* 4 inches */
                margin: 0;
                padding: 0.5cm; /* Padding para evitar sangrado */
                overflow: hidden;
                border: 1px solid white !important; /* Asegura que no haya bordes de impresión */
                box-shadow: none !important;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                font-family: sans-serif;
            }

            .barcode-code {
                font-size: 8px !important; 
                font-family: monospace;
                margin-top: 2px;
            }
        }
        
        /* Asegurarse de que el contenedor de impresión sea invisible por defecto */
        .print-label-view {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 9999;
            background: white;
            width: 100%;
        }
    </style>

    <script type="text/babel">
        // 3. CONFIGURACIÓN FIREBASE Y UTILIDADES
        const firebaseConfig = {
            // [AQUÍ IRÍAN LAS CLAVES DE CONFIGURACIÓN DE FIREBASE]
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Iconos de Lucide
        const Icon = ({ name, size = 20, className = "" }) => {
            const LucideIcon = lucide[name] || lucide.HelpCircle;
            return <LucideIcon size={size} className={className} />;
        };
        const { Menu, Home, CheckCircle, Clock, Archive, Settings, ArrowUp, ArrowDown, Search, Filter, Printer, Tag, Camera, X } = lucide;

        // Mapeo de estados de producción (existente)
        const statusMap = {
            'PENDIENTE': { step: 1, totalSteps: 4, color: 'bg-amber-500' },
            'EN PROCESO': { step: 2, totalSteps: 4, color: 'bg-blue-500' },
            'FINALIZADO': { step: 3, totalSteps: 4, color: 'bg-green-500' },
            'ENVIADO': { step: 4, totalSteps: 4, color: 'bg-indigo-500' },
            'ARCHIVADO': { step: 4, totalSteps: 4, color: 'bg-slate-500' },
        };
        
        // --- 4. NUEVOS COMPONENTES DE FUNCIONALIDAD ---

        // Componente: Etiqueta de Código de Barras (4"x6")
        const BarcodeLabel = ({ order, pkg, config }) => {
            const svgRef = React.useRef(null);
            // Combina el número de orden y el código del paquete
            const barcodeData = `${order.id}-${pkg.id}`; 
            
            // Asumiendo que `subPiecesData` y `progreso` contienen la información necesaria
            const pieceData = order.subPiecesData ? (order.subPiecesData.find(sp => sp.piezaNombre === pkg.piezaNombre || sp.pieza === pkg.piezaNombre) || order.subPiecesData[0] || {}) : {};
            const packageWeight = (((pkg.cantidad || 0) * (Number(pieceData.peso) || 0)) / 1000).toFixed(2); // Gramos a KG

            React.useEffect(() => {
                if (svgRef.current) {
                    JsBarcode(svgRef.current, barcodeData, {
                        format: "CODE128",
                        displayValue: true,
                        text: barcodeData,
                        fontSize: 10,
                        textMargin: 2,
                        margin: 0,
                        width: 1.5,
                        height: 40
                    });
                }
            }, [barcodeData]);

            // Datos ficticios para la demostración si no están en `order`
            const sampleThreading = [
                { guia: 'G1', material: 'PP 200D', porcentaje: 50 },
                { guia: 'G2', material: 'PE 300D', porcentaje: 50 },
            ];

            return (
                <div className="label-page bg-white text-black relative shadow-none">
                    
                    {/* --- Fila 1: Encabezado (Cliente, Orden, Máquina) --- */}
                    <div className="flex justify-between items-start border-b-2 border-black pb-1 mb-1">
                        <div className="text-left w-2/3">
                            <div className="text-[14px] font-black uppercase leading-tight">{order.cliente || 'CLIENTE PREDETERMINADO'}</div>
                            <div className="text-[10px] font-bold text-slate-700">ORD: {order.partida || order.id} / MOD: {order.codigo || order.modelo}</div>
                        </div>
                        <div className="text-right w-1/3">
                            <div className="text-[10px] font-bold uppercase text-slate-500">Máquina</div>
                            <div className="text-[24px] font-black text-red-600 leading-none">#{order.maquina || '01'}</div>
                        </div>
                    </div>

                    {/* --- Fila 2: Paquete y Peso --- */}
                    <div className="flex items-end justify-between py-1 border-b border-dashed border-slate-400 mb-2">
                        <div className="w-2/3">
                            <div className="text-[10px] font-bold uppercase text-slate-700">Pieza / Código Interno</div>
                            <div className="text-[18px] font-black truncate">{pkg.piezaNombre || 'PIEZA N/A'}</div>
                            <div className="text-[10px] font-mono leading-none">{pkg.codigoUnico || 'CODE-0000'}</div>
                        </div>
                        <div className="w-1/3 text-right">
                            <div className="text-[14px] font-black text-indigo-700 leading-none">{pkg.cantidad} PZS</div>
                            <div className="text-[12px] font-bold text-slate-600 leading-none">{packageWeight} Kg</div>
                        </div>
                    </div>

                    {/* --- Fila 3: Código de Barras y Datos de Enhebrado --- */}
                    <div className="flex justify-between items-center flex-grow pt-2">
                        <div className="w-3/5 flex flex-col items-center">
                            <svg ref={svgRef} className="w-full"></svg>
                            <div className="barcode-code text-center text-[8px] mt-1">{barcodeData}</div>
                        </div>
                        <div className="w-2/5 pl-3 border-l border-slate-300">
                            <div className="text-[10px] font-bold text-slate-700 mb-1 border-b border-slate-200 pb-0.5">ENHEBRADO:</div>
                            {(order.threading || sampleThreading).map((row, i) => (
                                <div key={i} className="flex justify-between text-[8px] font-bold leading-tight">
                                    <span>{row.guia}: {row.material}</span>
                                    <span className="text-red-600">{row.porcentaje}%</span>
                                </div>
                            ))}
                            <div className="text-[8px] font-bold text-slate-500 mt-3 border-t border-slate-200 pt-1">Impreso: {new Date().toLocaleDateString('es-MX')}</div>
                            <div className="text-[8px] font-bold text-slate-500">Orden Total: {order.totalPedido} Pzs</div>
                        </div>
                    </div>
                </div>
            );
        };

        // Componente: Vista de Impresión (Modal que activa la función de impresión)
        const PackageLabelsPrintView = ({ order, onBack }) => {
            React.useEffect(() => {
                const root = document.getElementById('root');
                const printContainer = document.getElementById('print-container');
                if (root) root.classList.add('no-print');
                if (printContainer) printContainer.classList.add('print-label-view');
                
                // Esperar un poco para asegurar el renderizado de las papeletas antes de imprimir
                setTimeout(() => window.print(), 100);

                return () => {
                    if (root) root.classList.remove('no-print');
                    if (printContainer) printContainer.classList.remove('print-label-view');
                };
            }, []);

            return (
                <div className="fixed inset-0 bg-black/90 z-[70] flex items-center justify-center">
                    <div className="bg-white p-6 rounded-lg shadow-2xl max-w-lg text-center">
                        <h3 className="font-black text-2xl mb-2 text-purple-700">Modo de Impresión</h3>
                        <p className="font-bold text-lg mb-4">Generando {order.progreso ? order.progreso.length : 0} Papeletas...</p>
                        <p className="text-sm text-slate-600 mb-6">Por favor, presiona 'Imprimir' en la ventana que aparece. Si la ventana se cierra, haz clic en el botón de abajo.</p>
                        <button onClick={onBack} className="bg-red-500 text-white px-4 py-2 rounded font-bold shadow-lg flex items-center gap-1 mx-auto hover:bg-red-600 transition-colors">
                            <Icon name="X" size={18}/> CERRAR VISTA DE IMPRESIÓN
                        </button>
                    </div>
                </div>
            );
        };

        // Componente: Lector de Código de Barras (Escáner con Cámara)
        const BarcodeScanner = ({ onClose, onScanSuccess }) => {
            const [error, setError] = React.useState(null);
            const [status, setStatus] = React.useState('Esperando escaneo...');
            const videoRef = React.useRef(null);
            const codeReaderRef = React.useRef(null);
            
            // Simulación de lista de tejedores
            const TEJEDORES = ["BALTA", "ANDRÉS", "JUAN", "MARÍA"];
            const [entry, setEntry] = React.useState({ tejedor: TEJEDORES[0], fecha: new Date().toISOString().split('T')[0] });

            React.useEffect(() => {
                const codeReader = new ZXing.BrowserMultiFormatReader();
                codeReaderRef.current = codeReader;

                codeReader.listVideoInputDevices().then((videoInputDevices) => {
                    if (videoInputDevices.length === 0) {
                        setError("No se detectaron cámaras.");
                        setStatus('Error: No hay cámaras disponibles.');
                        return;
                    }
                    
                    const selectedDeviceId = videoInputDevices[0].deviceId;
                    
                    codeReader.decodeFromVideoDevice(selectedDeviceId, videoRef.current, (result, err) => {
                        if (result) {
                            codeReader.reset();
                            setStatus('Código detectado. Procesando...');
                            onScanSuccess(result.text, entry); 
                            onClose(); 
                        }
                        if (err && !(err instanceof ZXing.NotFoundException)) {
                            // Errores no críticos (como no encontrar el código en un frame) se ignoran
                        }
                    });
                }).catch((err) => {
                    console.error(err);
                    setError("No se pudo iniciar la cámara. Asegúrate de tener permisos.");
                    setStatus('Error: No se pudo iniciar la cámara.');
                });

                return () => {
                    // Limpieza: detener el escáner
                    if (codeReaderRef.current) codeReaderRef.current.reset();
                };
            }, [entry.tejedor, entry.fecha]);

            return (
                <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4">
                    <div className="bg-white p-6 rounded-lg shadow-2xl w-full max-w-2xl relative">
                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 className="font-bold text-xl text-indigo-700 flex items-center gap-2"><Icon name="Camera" size={24}/> Lector de Paquetes</h3>
                            <button onClick={onClose} className="bg-red-500 hover:bg-red-600 text-white rounded-md p-2 shadow-lg flex items-center gap-1 font-bold text-xs transition-transform hover:scale-105">
                                <Icon name="X" size={18}/> CERRAR
                            </button>
                        </div>
                        
                        <div className="bg-slate-800 rounded mb-4 overflow-hidden relative">
                            <video ref={videoRef} className="w-full h-auto max-h-96"></video>
                            {error && <div className="absolute inset-0 bg-black/70 text-red-400 flex items-center justify-center p-4 font-bold text-center">{error}</div>}
                        </div>

                        <div className="flex gap-4 items-end mb-4 bg-slate-50 p-3 rounded shadow-inner">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">TEJEDOR</label>
                                <select 
                                    value={entry.tejedor} 
                                    onChange={e=>setEntry({...entry, tejedor: e.target.value})} 
                                    className="border-2 border-slate-300 p-2 rounded w-40 font-bold text-indigo-700 focus:border-indigo-500 outline-none"
                                >
                                    {TEJEDORES.map(t => <option key={t} value={t}>{t}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">FECHA DE TERMINADO</label>
                                <input 
                                    type="date" 
                                    value={entry.fecha} 
                                    onChange={e=>setEntry({...entry, fecha: e.target.value})} 
                                    className="border-2 border-slate-300 p-2 rounded font-mono cursor-pointer hover:bg-slate-100"
                                />
                            </div>
                        </div>

                        <p className="text-center font-bold text-sm text-slate-600">{status}</p>
                    </div>
                </div>
            );
        };
        
        // --- 5. COMPONENTE ORDERVIEW (Simplificado para el botón de impresión) ---
        const OrderView = ({ order, onClose, onUpdateStatus, onArchive, onUnarchive, onDelete, viewMode }) => {
             // ... Tu lógica de OrderDetail
             if (!order) return null;

             const [showLabelsPrint, setShowLabelsPrint] = React.useState(false);
             
             // Simulación de datos de progreso/paquetes
             const orderWithProgreso = {
                 ...order,
                 progreso: order.progreso || [
                     { id: 'PKG001', piezaNombre: 'DELANTERO XS', cantidad: 50, codigoUnico: 'DXS-P001' },
                     { id: 'PKG002', piezaNombre: 'DELANTERO S', cantidad: 50, codigoUnico: 'DXS-P002' },
                     { id: 'PKG003', piezaNombre: 'ESPALDA L', cantidad: 100, codigoUnico: 'ESL-P003' },
                 ],
                 threading: [
                    { guia: 'G1', material: 'PP 200D', porcentaje: 50 },
                    { guia: 'G2', material: 'PE 300D', porcentaje: 50 },
                ],
             };

             // El resto del OrderDetail (simplificado)
             const isArchived = order.status === 'ARCHIVADO';
             
             return (
                 <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-end">
                    
                    {/* NUEVA VISTA DE IMPRESIÓN */}
                    {showLabelsPrint && <PackageLabelsPrintView order={orderWithProgreso} onBack={() => setShowLabelsPrint(false)} />} 
                    
                     <div className="w-full md:w-1/3 bg-white h-full shadow-2xl overflow-y-auto no-print">
                         <div className="p-6">
                            <div className="flex justify-between items-start mb-6 border-b pb-3">
                                 <h2 className="text-2xl font-bold text-slate-800">Orden #{order.id}</h2>
                                 <button onClick={onClose} className="text-slate-500 hover:text-slate-800">
                                     <Icon name="X" className="w-6 h-6"/>
                                 </button>
                             </div>
                             
                             <div className="mb-6 p-4 border rounded-lg bg-slate-50">
                                 <div className="text-xl font-extrabold text-green-600 mb-2">{order.status}</div>
                                 <p className="text-sm text-slate-600">Cliente: <span className="font-semibold">{order.cliente}</span></p>
                                 <p className="text-sm text-slate-600">Total: <span className="font-semibold">{order.totalPedido} pzs</span></p>
                             </div>
                             
                             <h3 className="text-lg font-semibold mb-3 text-slate-700">Acciones</h3>
                             {viewMode === 'active' && !isArchived && (
                                 <div className="flex flex-wrap gap-2 mb-6">
                                    <button 
                                        onClick={() => setShowLabelsPrint(true)} 
                                        className="bg-purple-600 text-white px-3 py-1 rounded font-bold text-xs flex items-center gap-1 hover:bg-purple-700 shadow-md transition-transform hover:scale-[1.02]"
                                    >
                                        <Icon name="Printer" size={16}/> IMPRIMIR PAPELETAS ({orderWithProgreso.progreso.length})
                                    </button>
                                     {/* Botones de cambio de estado simplificados */}
                                     <button 
                                         onClick={() => onUpdateStatus(order.id, 'FINALIZADO')}
                                         className={`px-3 py-1 text-sm font-medium rounded-full bg-green-500 text-white hover:bg-green-600 transition-colors`}
                                     >
                                         Mover a FINALIZADO
                                     </button>
                                     <button onClick={() => onArchive(order.id)} className="px-3 py-1 text-sm font-medium rounded-full bg-slate-500 text-white hover:bg-slate-600 transition-colors">
                                         <Icon name="Archive" size={14} className="inline mr-1"/> Archivar
                                     </button>
                                 </div>
                             )}
                             
                             {/* Mostrar listado de paquetes con estado de terminado (simulado) */}
                             <h3 className="text-lg font-semibold mb-3 text-slate-700 border-t pt-4">Paquetes ({orderWithProgreso.progreso.length})</h3>
                             <ul className="space-y-2">
                                {orderWithProgreso.progreso.map(pkg => (
                                    <li key={pkg.id} className="p-3 border rounded-lg flex justify-between items-center bg-white">
                                        <span className="font-medium">{pkg.piezaNombre} ({pkg.cantidad} pzs)</span>
                                        {/* Simular que el primer paquete está terminado para la demo */}
                                        <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${pkg.id === 'PKG001' ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}`}>
                                            {pkg.id === 'PKG001' ? 'TERMINADO (Demo)' : 'PENDIENTE'}
                                        </span>
                                    </li>
                                ))}
                             </ul>
                             
                         </div>
                     </div>
                 </div>
             );
        };

        // --- 6. COMPONENTE APP (Dashboard principal) ---
        const App = () => {
            const [orders, setOrders] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [viewMode, setViewMode] = React.useState('active');
            const [selectedOrder, setSelectedOrder] = React.useState(null);
            const [searchQuery, setSearchQuery] = React.useState('');
            const [filterStatus, setFilterStatus] = React.useState('ALL');
            const [showScanner, setShowScanner] = React.useState(false); // <--- NUEVO ESTADO ESCÁNER

            // 4. FUNCIÓN PARA OBTENER DATOS (EXISTENTE)
            React.useEffect(() => {
                const unsubscribe = db.collection('pedidos')
                    .orderBy('fechaEntrega', 'asc')
                    .onSnapshot(snapshot => {
                        const loadedOrders = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data(),
                            totalPedido: parseInt(doc.data().totalPedido || 0),
                            totalCompletado: parseInt(doc.data().totalCompletado || 0),
                            status: doc.data().status || 'PENDIENTE',
                            cliente: doc.data().cliente || 'N/A',
                            modelo: doc.data().modelo || 'N/A',
                            fechaEntrega: doc.data().fechaEntrega ? new Date(doc.data().fechaEntrega.seconds * 1000) : null
                        }));
                        setOrders(loadedOrders);
                        setLoading(false);
                    }, error => {
                        console.error("Error fetching documents: ", error);
                        setLoading(false);
                    });
                
                return () => unsubscribe();
            }, []);

            // --- 7. NUEVA FUNCIÓN PARA PROCESAR EL ESCANEO ---
            const handleScan = async (barcodeData, entry) => {
                const parts = barcodeData.split('-'); // Espera formato: ORDER_ID-PACKAGE_ID
                if (parts.length !== 2) {
                    return alert(`Error: Formato de código de barras incorrecto: ${barcodeData}. Se esperaba ORDER_ID-PACKAGE_ID.`);
                }
                const [orderId, packageId] = parts;
                
                // 1. Encontrar la orden
                const orderToUpdate = orders.find(o => String(o.id) === orderId);
                if (!orderToUpdate) {
                    return alert(`Error: No se encontró la orden con ID ${orderId}.`);
                }

                // Simular que el progreso viene de la base de datos
                const progreso = orderToUpdate.progreso || [
                    { id: 'PKG001', piezaNombre: 'DELANTERO XS', cantidad: 50, finished: false }, 
                    { id: 'PKG002', piezaNombre: 'DELANTERO S', cantidad: 50, finished: false }
                ];
                
                // 2. Encontrar el paquete
                const packageToUpdate = progreso.find(p => String(p.id) === packageId);
                if (!packageToUpdate) {
                    return alert(`Error: Paquete ${packageId} no encontrado en la orden ${orderToUpdate.id}.`);
                }
                if (packageToUpdate.finished) {
                    return alert(`Advertencia: El paquete de ${packageToUpdate.piezaNombre} ya estaba registrado como LISTO.`);
                }

                // 3. Crear el nuevo progreso (marcar como terminado)
                const newProgreso = progreso.map(p => 
                    String(p.id) === packageId
                        ? { ...p, finished: true, tejedor: entry.tejedor, fecha: entry.fecha, defectos: '', agujas: '' }
                        : p
                );

                // 4. Actualizar en Firebase
                try {
                    // Actualizar el progreso y el total completado
                    const newTotalCompletado = newProgreso.filter(p => p.finished).reduce((sum, p) => sum + p.cantidad, 0);
                    
                    await db.collection('pedidos').doc(orderId).update({ 
                        progreso: newProgreso,
                        totalCompletado: newTotalCompletado,
                        status: newTotalCompletado >= orderToUpdate.totalPedido ? 'FINALIZADO' : 'EN PROCESO' 
                    });
                    
                    alert(`✅ ¡Paquete de ${packageToUpdate.piezaNombre} de la orden ${orderToUpdate.id} marcado como LISTO por ${entry.tejedor} sin entrada manual!`);
                } catch (e) {
                    console.error("Error al actualizar el estado del paquete: ", e);
                    alert("Error al actualizar el estado del paquete.");
                }
            };
            
            // 8. OTRAS FUNCIONES (Existentes)
            const handleOrderClick = (order) => { setSelectedOrder(order); };
            const handleCloseDetail = () => { setSelectedOrder(null); };
            const handleUpdateStatus = async (orderId, newStatus) => { 
                // ... Lógica existente
                alert(`Simulación: Estado de la orden ${orderId} actualizado a ${newStatus}. (Lógica de DB simplificada)`);
            };
            const handleArchive = async (orderId) => {
                // ... Lógica existente
                alert(`Simulación: Orden ${orderId} archivada. (Lógica de DB simplificada)`);
            };
            const handleUnarchive = async (orderId) => {
                // ... Lógica existente
                 alert(`Simulación: Orden ${orderId} reactivada. (Lógica de DB simplificada)`);
            };
            const handleDelete = async (orderId) => {
                // ... Lógica existente
                alert(`Simulación: Orden ${orderId} eliminada. (Lógica de DB simplificada)`);
            };
            
            // Filtrado de Órdenes (Existente)
            const filteredOrders = orders
                .filter(order => {
                    const isArchived = order.status === 'ARCHIVADO';
                    if (viewMode === 'active' && isArchived) return false;
                    if (viewMode === 'history' && !isArchived) return false;
                    if (filterStatus !== 'ALL' && order.status !== filterStatus) return false;
                    if (searchQuery) {
                        const query = searchQuery.toLowerCase();
                        return (
                            order.id.toLowerCase().includes(query) ||
                            (order.cliente && order.cliente.toLowerCase().includes(query)) ||
                            (order.modelo && order.modelo.toLowerCase().includes(query))
                        );
                    }
                    return true;
                })
                .sort((a, b) => {
                    if (a.fechaEntrega && b.fechaEntrega) return a.fechaEntrega.getTime() - b.fechaEntrega.getTime();
                    if (a.fechaEntrega && !b.fechaEntrega) return -1;
                    if (!a.fechaEntrega && b.fechaEntrega) return 1;
                    return a.id.localeCompare(b.id);
                });
                
            const displayedOrders = filteredOrders;
            const DashboardBottom = ({ activeOrders }) => { /* ... componente existente ... */ return null; };
            const SideNav = ({ viewMode, setViewMode, orders }) => { /* ... componente existente ... */ return null; };


            // 9. RENDERIZADO PRINCIPAL
            return (
                <div className="flex h-screen bg-slate-100">
                    <SideNav viewMode={viewMode} setViewMode={setViewMode} orders={orders} />
                    
                    {/* Renderiza el detalle de la orden */}
                    {selectedOrder && (
                        <OrderView 
                            order={selectedOrder} 
                            onClose={handleCloseDetail}
                            onUpdateStatus={handleUpdateStatus}
                            onArchive={handleArchive}
                            onUnarchive={handleUnarchive}
                            onDelete={handleDelete}
                            viewMode={viewMode}
                        />
                    )}
                    
                    {/* NUEVO: Renderiza el modal del escáner */}
                    {showScanner && <BarcodeScanner onClose={()=>setShowScanner(false)} onScanSuccess={handleScan} />}


                    {/* Contenido principal del dashboard */}
                    <div className="flex-grow flex flex-col overflow-hidden">
                        
                        <header className="bg-white p-4 shadow-md flex justify-between items-center z-10">
                            <h1 className="text-2xl font-semibold text-slate-800">
                                {viewMode === 'active' ? 'Órdenes Activas' : 'Historial de Órdenes'}
                            </h1>
                            <div className="flex items-center space-x-4">
                                
                                {/* --- BOTÓN ESCÁNER --- */}
                                <button onClick={()=>setShowScanner(true)} className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-bold shadow flex items-center gap-2 text-sm transition-transform hover:scale-105">
                                    <Icon name="Camera" size={20}/> ESCÁNER (PAQUETES)
                                </button>
                                
                                <div className="relative">
                                    <Search className="w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"/>
                                    <input 
                                        type="text"
                                        placeholder="Buscar por ID, cliente o modelo..."
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        className="pl-10 pr-4 py-2 border rounded-full text-sm w-64 focus:ring-blue-500 focus:border-blue-500"
                                    />
                                </div>
                                
                                <select 
                                    value={filterStatus}
                                    onChange={(e) => setFilterStatus(e.target.value)}
                                    className="p-2 border rounded-full text-sm appearance-none bg-white pr-8"
                                >
                                    <option value="ALL">Mostrar todos los estados</option>
                                    {Object.keys(statusMap)
                                        .filter(s => viewMode === 'active' ? s !== 'ARCHIVADO' : true)
                                        .map(status => (
                                            <option key={status} value={status}>{status}</option>
                                        ))}
                                    {viewMode === 'history' && <option value="ARCHIVADO">ARCHIVADO</option>}
                                </select>
                            </div>
                        </header>
                        
                        <div className="flex-grow overflow-y-auto p-6">
                            {loading && <div className="text-center text-slate-500 py-10 font-bold">Cargando órdenes...</div>}
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                {displayedOrders.map(o => {
                                    const statusInfo = statusMap[o.status] || { step: 0, totalSteps: 4, color: 'bg-gray-500' };
                                    const pct = o.totalPedido > 0 ? (o.totalCompletado / o.totalPedido) * 100 : 0;
                                    const isDueSoon = o.fechaEntrega && (o.fechaEntrega.getTime() - Date.now()) < (7 * 24 * 60 * 60 * 1000) && o.status !== 'FINALIZADO' && o.status !== 'ENVIADO' && o.status !== 'ARCHIVADO';
                                    
                                    return (
                                        <div 
                                            key={o.id} 
                                            onClick={() => handleOrderClick(o)}
                                            className={`p-4 border rounded-xl shadow-lg bg-white cursor-pointer transition-shadow hover:shadow-xl relative ${isDueSoon ? 'border-amber-500 ring-2 ring-amber-500' : 'border-slate-200'}`}
                                        >
                                            <div className="flex justify-between items-start mb-2">
                                                <h3 className="font-extrabold text-sm text-slate-900">#{o.id}</h3>
                                                <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${o.status === 'ARCHIVADO' ? 'bg-slate-200 text-slate-600' : `${statusInfo.color.replace('bg-', 'bg-')} text-white`}`}>
                                                    {o.status}
                                                </span>
                                            </div>
                                            <p className="text-sm font-semibold text-slate-700">{o.cliente}</p>
                                            <p className="text-xs text-slate-500 mb-2">{o.modelo}</p>
                                            <div className="text-[10px] text-slate-400">Entrega: {o.fechaEntrega ? o.fechaEntrega.toLocaleDateString('es-ES') : 'N/A'}</div>
                                            <div className="text-[10px] text-slate-400">Total: {o.totalPedido} pzs</div>
                                            <div className="mt-2 w-full bg-slate-100 h-2 rounded overflow-hidden">
                                                <div className={`${o.status === 'ARCHIVADO' ? 'bg-slate-500' : 'bg-green-500'} h-full`} style={{width:`${pct}%`}}></div>
                                            </div>
                                            {o.status === 'ARCHIVADO' && <div className="text-center text-[10px] font-bold text-slate-500 mt-1">ARCHIVADO</div>}
                                        </div>
                                    );
                                })}
                                {displayedOrders.length === 0 && <div className="col-span-4 text-center text-slate-400 py-10 font-bold">No hay órdenes en esta vista.</div>}
                            </div>
                        </div>
                        
                        {viewMode === 'active' && <DashboardBottom activeOrders={displayedOrders} />}
                        {viewMode === 'history' && <div className="bg-slate-800 text-white flex items-center justify-center p-10 font-bold text-xl opacity-50">MODO HISTORIAL - SOLO LECTURA</div>}
                        
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    
    <div id="print-container"></div>
</body>
</html>