<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Ropa Seamless | Venta WhatsApp</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración de la fuente Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fcfcfc;
        }
        .seamless-bg {
            background-color: #fcfcfc;
        }
        .whatsapp-btn {
            background: linear-gradient(135deg, #128C7E 0%, #25D366 100%);
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4);
        }
        .whatsapp-btn:hover {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
        }
        .thumbnail-active {
            border: 3px solid #3b82f6; /* Borde azul para la foto activa */
            opacity: 100% !important;
        }
        .llm-output {
            white-space: pre-wrap;
            text-align: left;
            padding: 1rem;
            border-radius: 0.75rem;
            background-color: #f3f4f6;
            margin-top: 1rem;
            font-size: 0.9rem;
            border-left: 4px solid #3b82f6;
        }
        /* Estilo para el botón de ir atrás */
        .back-nav-btn {
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            color: #3b82f6;
            transition: color 150ms;
        }
        .back-nav-btn:hover {
            color: #1d4ed8;
        }
    </style>
    <!-- Iconos (Inline SVG para evitar dependencias) -->
    <svg style="display: none;">
        <symbol id="icon-whatsapp" viewBox="0 0 24 24">
            <path fill="currentColor" d="M12.03 2.05c-5.46 0-9.92 4.46-9.92 9.92 0 1.94.57 3.8.31 5.43l-.42 2.74c-.07.45.36.8.81.74l3.18-.52c1.78.29 3.63.43 5.9.43 5.46 0 9.92-4.46 9.92-9.92.01-5.46-4.46-9.92-9.93-9.92zm3.32 12.87c-.07.13-.25.21-.49.21-.24 0-.44-.09-.64-.17-.46-.19-1.28-.52-2.17-1.34-.89-.83-1.48-1.92-1.66-2.31-.07-.15-.15-.22-.22-.36-.08-.14-.07-.33.02-.45.09-.13.25-.13.37-.13.12 0 .26.01.37.01.21 0 .28.05.4.31.11.23.38.93.42 1.01.04.09.07.18.01.29-.07.11-.13.17-.25.32-.1.14-.19.23-.29.35-.1.1-.19.23-.07.43.12.2.35.59.82.98.47.4.92.57 1.13.68.21.11.33.09.43.06.1-.03.22-.11.34-.19.12-.08.24-.13.38-.17.13-.04.28.01.38.15.1.14.1.4.01.52z"/>
        </symbol>
        <symbol id="icon-cart" viewBox="0 0 24 24">
            <path fill="currentColor" d="M17 18.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM6 18.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zm13.1-10h-2.1l-.8-3.4c-.2-.7-.8-1.1-1.6-1.1H8.4c-.8 0-1.4.4-1.6 1.1l-.8 3.4H4.9c-.6 0-1.1.5-1.1 1.1v7c0 .6.5 1.1 1.1 1.1h14.2c.6 0 1.1-.5 1.1-1.1v-7c0-.6-.5-1.1-1.1-1.1zM8.5 6.5h7l.4 1.7h-7.8l.4-1.7zm10.6 12.8H5.9v-7h13.2v7z"/>
        </symbol>
        <symbol id="icon-back" viewBox="0 0 24 24">
            <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
        </symbol>
    </svg>
</head>
<body class="seamless-bg antialiased flex flex-col items-center">

    <!-- IMAGEN DE ENCABEZADO -->
    <div class="w-full max-w-xl p-4 pt-6 pb-2">
        <img src="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/rosasandoval/refs/heads/main/Miss%20rouss.jpg" 
             alt="Logo de la marca Seamless" 
             class="w-full h-auto object-contain rounded-xl shadow-lg border border-gray-100 mx-auto">
    </div>
    <!-- FIN IMAGEN -->

    <!-- Contenedor Principal de la App (Pantalla completa en móvil) -->
    <div id="app" class="min-h-screen w-full max-w-xl mx-auto shadow-xl bg-white">

        <!-- Header Fijo (Solo Título y Carrito) -->
        <header class="p-4 bg-white border-b border-gray-100 sticky top-0 z-10 shadow-sm flex justify-between items-center">
            <h1 class="text-2xl font-extrabold text-gray-800 text-center flex-grow">
                CATÁLOGO
            </h1>
            
            <!-- Botón y Contador del Carrito -->
            <button id="cart-button" onclick="renderCartView()" class="relative p-2 bg-blue-50 text-blue-600 rounded-full hover:bg-blue-100 transition duration-150">
                <svg class="w-6 h-6" aria-hidden="true"><use xlink:href="#icon-cart"></use></svg>
                <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full hidden">0</span>
            </button>
        </header>

        <!-- Vistas -->
        <main class="p-4">

            <!-- 1. Vista de Categorías -->
            <div id="category-view" class="space-y-3">
                <p class="text-gray-500 mb-4 text-center text-sm">Selecciona una categoría para ver los modelos disponibles.</p>
                <!-- Las categorías se inyectarán aquí por JS -->
            </div>

            <!-- 2. Vista de Modelos de la Categoría -->
            <div id="product-list-view" class="hidden">
                <!-- Botón de Retroceso a Categorías -->
                <button onclick="goBackToCategories()" class="back-nav-btn cursor-pointer">
                    <svg class="w-4 h-4 mr-1" aria-hidden="true"><use xlink:href="#icon-back"></use></svg>
                    Volver a Categorías
                </button>
                
                <h2 id="current-category-title" class="text-xl font-bold text-gray-700 mb-4"></h2>
                <div id="models-container" class="grid grid-cols-2 gap-4">
                    <!-- Los 5 modelos se inyectarán aquí por JS -->
                </div>
            </div>
            
            <!-- 3. Vista de Detalle del Producto (Modal simulado) -->
            <div id="product-detail-view" class="hidden p-4 bg-white rounded-xl">
                <!-- Botón de Retroceso a Lista de Productos -->
                <button onclick="goBackToProducts()" class="back-nav-btn cursor-pointer">
                    <svg class="w-4 h-4 mr-1" aria-hidden="true"><use xlink:href="#icon-back"></use></svg>
                    Volver a Modelos
                </button>
                
                <!-- Galería de Fotos - FONDO NEGRO FORZADO -->
                <div class="space-y-2 mb-6 p-4 bg-gray-900 text-white rounded-xl shadow-inner" style="background-color: #000000;">
                    <!-- Foto Principal -->
                    <img id="detail-main-image" src="" alt="Foto principal del modelo" class="w-full h-auto object-cover rounded-xl shadow-lg">
                    <!-- Miniaturas -->
                    <div id="detail-thumbnails" class="grid grid-cols-5 gap-2 pt-2">
                        <!-- Las miniaturas se inyectarán aquí por JS -->
                    </div>
                </div>

                <div class="mb-6">
                    <h3 id="detail-model-name" class="text-2xl font-bold text-gray-800 mb-1">Modelo de Ejemplo</h3>
                    <p id="detail-category-name" class="text-md font-medium text-gray-500 mb-3"></p>
                    <p id="detail-price" class="text-3xl font-extrabold text-blue-600 mb-4">$X.XXX MXN</p>
                </div>
                
                <!-- Formulario de Opciones para el Carrito -->
                <form id="order-form" class="space-y-4">
                    
                    <!-- Selector de Colores (Este grupo se oculta si no hay colores) -->
                    <div id="color-selector-group">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Color</label>
                        <select id="selected-color" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
                            <!-- Colores se inyectarán aquí -->
                        </select>
                    </div>

                    <!-- Cantidad -->
                    <div>
                        <label for="selected-quantity" class="block text-sm font-semibold text-gray-700 mb-2">Cantidad</label>
                        <input type="number" id="selected-quantity" value="1" min="1" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Botón de Añadir al Carrito -->
                    <button type="submit" id="add-to-cart-btn" disabled
                            class="w-full p-4 mt-6 rounded-xl text-white font-bold text-lg flex items-center justify-center space-x-2 transition duration-300 bg-blue-600 hover:bg-blue-700 opacity-50 disabled:cursor-not-allowed">
                        Añadir al Carrito
                    </button>
                    <p id="validation-message" class="text-center text-red-500 text-sm hidden">Selecciona Color para añadir al carrito.</p>
                </form>
            </div>

            <!-- 4. Vista del Carrito de Compras -->
            <div id="cart-view" class="hidden p-4 bg-white rounded-xl">
                <!-- Botón de Retroceso a Lista de Productos -->
                <button onclick="goBackToProducts()" class="back-nav-btn cursor-pointer">
                    <svg class="w-4 h-4 mr-1" aria-hidden="true"><use xlink:href="#icon-back"></use></svg>
                    Seguir Comprando
                </button>

                <h2 class="text-2xl font-bold text-gray-800 mb-4">Tu Carrito de Compras</h2>
                
                <div id="cart-items-container" class="space-y-4 mb-6">
                    <!-- Items del carrito se inyectarán aquí -->
                </div>
                
                <div class="text-right text-xl font-semibold text-gray-700 border-t pt-4">
                    Total de artículos: <span id="cart-total-items" class="text-blue-600">0</span>
                </div>

                <!-- Ideas de Outfit LLM -->
                <button id="outfit-ideas-btn" 
                        onclick="getOutfitIdeas()" 
                        disabled
                        class="w-full p-3 mt-4 rounded-lg text-sm font-bold flex items-center justify-center space-x-2 transition duration-300 
                               bg-indigo-100 text-indigo-800 hover:bg-indigo-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span>✨ Generar Ideas de Outfit con Gemini</span>
                    <span id="outfit-loading" class="hidden animate-spin h-4 w-4 border-2 border-indigo-800 border-t-transparent rounded-full"></span>
                </button>
                <div id="outfit-ideas-output" class="hidden"></div>
                <!-- END NEW -->

                <!-- Botón Final de WhatsApp -->
                <button id="whatsapp-order-btn" onclick="sendWhatsAppOrder()" disabled
                        class="whatsapp-btn w-full p-4 mt-6 rounded-xl text-white font-bold text-lg flex items-center justify-center space-x-2 transition duration-300 opacity-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-6 h-6" aria-hidden="true"><use xlink:href="#icon-whatsapp"></use></use></svg>
                    <span>CONFIRMAR PEDIDO POR WHATSAPP</span>
                </button>
            </div>
            
            <!-- Contenedor para mensajes de error (toast) -->
            <div id="toast-container" class="fixed bottom-4 right-4 z-50"></div>

        </main>
    </div>

    <!-- JavaScript del Catálogo -->
    <script>
        // --- CONFIGURACIÓN DE GEMINI API ---
        const API_MODEL = 'gemini-2.5-flash-preview-05-20';
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${apiKey}`;

        // --- DATA MOCKUP (Simulación de la Base de Datos Estática) ---
        const WHATSAPP_NUMBER = "+524451103626";
        const BASE_CATEGORY_NAMES = [
            "Conjuntos Deportivos", "Enterizos", "Leggings", "Shorts", "Oversize",
            "Blusas", "Calcetas"
        ];
        
        // -------------------------------------------------------------
        // CONJUNTOS DEPORTIVOS - MODELO 1 
        // -------------------------------------------------------------
        const CONJUNTO_MODEL_1_IMAGES = [
            "https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/rosasandoval/refs/heads/main/CONJUNTO1%20(4).png", 
            "https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/rosasandoval/refs/heads/main/CONJUNTO1%20(1).png",
            "https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/rosasandoval/refs/heads/main/CONJUNTO1%20(2).png",
            "https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/rosasandoval/refs/heads/main/CONJUNTO1%20(3).png",
            "https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/rosasandoval/refs/heads/main/CONJUNTO1%20(5).png"
        ];
        
        // -------------------------------------------------------------
        // ENTERIZOS (Lista completa de 33 URLs)
        // -------------------------------------------------------------
        const ENTERIZO_IMAGES = [
            // URLs originales (10)
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0013.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0014.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0043.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0045.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0046.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0047.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0048.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0049.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0050.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0058.jpg?raw=true",
            // Nuevas URLs añadidas (23)
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0059.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0060.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0061.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0062.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0063.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0064.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0065.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0066.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0067.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0068.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0073.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0074.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0082.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0083.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0084.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0086.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0087.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0090.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0091.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0092.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0093.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0096.jpg?raw=true",
            "https://github.com/jesusvn1993mplvt3-ai/rosasandoval/blob/main/fotos/Enterizos/IMG-20251011-WA0097.jpg?raw=true"
        ];

        // -------------------------------------------------------------
        // LEGGINGS - MODELO 1 
        // -------------------------------------------------------------
        const LEGGINGS_MODEL_1_IMAGES = [
            // FOTO 1 (Principal)
            "https://blogger.googleusercontent.com/img/a/AVvXsEgs590X4v6riaUrexeEHGLIJmLC94sg4gJeZ7iY42JMqc0KUBeJ9E4kalyFg61vzQ3gD4PPrFYzipkm10rzWHCoGPC5cbk4O5lxC4FxwD8SHVb4ujO6Z04NCwyyLpE7yaNawuikBj2tIzslUEP2I_aILElHaUwwdhj87OMychqjSXCkubz7bQQ2qo73bSc",
            // FOTO 2 
            "https://blogger.googleusercontent.com/img/a/AVvXsEgsjUrVy4mxWPctXMu1DAsj1wPTQ363HcbE8ftZvzt9-LGHTobjAKfeLw1V2CBES6lPPEnrC9dN-Z2Q7fwwTvLOkUNArqltlqdWy_7TlVlg59Resygq7s9Op8eq90kh_Z9qVpuvF0IQ0L2c0XViKCkoYjlpX63djYsKsQPBC7D2z2DG9bGZPltNYv2g974", 
            // FOTO 3
            "https://blogger.googleusercontent.com/img/a/AVvXsEj2-YyfL8n8rMbL08S0ZD2ng26_dTs_VVtb0YphpTnWD43ohMWMQYEcAkuuOrLFcJ2vkm_1fmiytXd7ySmiuqp6_kh7AZWWSYfL4kqz-lOtfH2XuE9xQWqtSS0fMMLMBX8CkejWF3i0UEpo9KHFZbl430A41aij9tj7cWPLQ1xV6Q6bI--SW_S_7S5EjEM", 
            // FOTO 4
            "https://blogger.googleusercontent.com/img/a/AVvXsEi7wfD58k5-qcbMjpmW-46TYecIGa1_J18Ys77aL6YaEDXN7-gNXvXZiLZzJYEUcm9tnkmlF8LvlPRBAs04RKIY5qdKm-KZWIXmiA-qzWxbVS11GcSEnzHp5PBKqyeMWRlBXNBIMojz5iYGkTwl9zL1duKqxSkdp1BIWSmWLYKQv-RENR4e1aGT9Y6y8Z8",
            // FOTO 5 
            "https://blogger.googleusercontent.com/img/a/AVvXsEic3nBSl0NjjQy9jnUBOv-iqkdvDj5kOrIQ6Xk45OxN8ba7vsuX3aQ9N5MzQ10_6kShn2n_lqNj4D-XFatqYwbiGyq0veP1ZJaZXx6w09Eg34L_sP6q-0eHGAdAc9vpxHXUgs7S0dnhW4aRoz7qqssBRFrB0IOaiQifJSuVmKF_oDSGVe0HN2z9oaF_CR0g"
        ];
        
        // Genera modelos placeholder, ajustando la cantidad de Enterizos
        const CATALOG_DATA_MODELS = BASE_CATEGORY_NAMES.reduce((acc, cat) => {
            const isEnterizo = cat === "Enterizos";
            // Si es Enterizos, usa la longitud de la lista completa (33)
            const count = isEnterizo ? ENTERIZO_IMAGES.length : 5; 

            acc[cat] = Array.from({ length: count }, (_, i) => {
                const isLegging1 = cat === "Leggings" && i === 0;
                const isConjunto1 = cat === "Conjuntos Deportivos" && i === 0;
                
                let modelData = {
                    id: `${cat.substring(0, 3)}-${i + 1}`,
                    name: `${cat} - Modelo ${i + 1}`,
                    price: (250 + (i * 50)).toFixed(2), 
                    image: `https://placehold.co/300x400/000000/ffffff?text=MOD+${i+1}`, 
                    gallery: Array.from({ length: 5 }, (_, j) => `https://placehold.co/100x100/000000/ffffff?text=FOTO+${j+1}`), 
                    colors: ["Negro", "Gris Humo", "Beige", "Rosa Pastel", "Azul Acero"],
                };

                if (isEnterizo) {
                    // Modelos de Enterizos (un solo color, una sola foto)
                    const enterizoId = i + 1;
                    modelData.id = `ENT-${enterizoId}`;
                    modelData.name = `Enterizo Seamless E${enterizoId}`;
                    // Un precio base para los nuevos modelos (se mantiene el esquema de precios anterior)
                    modelData.price = (299.00 + (i * 5)).toFixed(2); 
                    
                    // Usar la URL de la lista de ENTERIZO_IMAGES.
                    const imageUrl = ENTERIZO_IMAGES[i] || modelData.image; 
                    modelData.image = imageUrl; 
                    modelData.gallery = [imageUrl]; // Unica foto como galería
                    modelData.colors = []; // Sin opciones de color
                } else if (isConjunto1) {
                    modelData.name = "Conjunto Deportivo V1 (Seamless)";
                    modelData.price = '150.00'; 
                    modelData.image = CONJUNTO_MODEL_1_IMAGES[0];
                    modelData.gallery = CONJUNTO_MODEL_1_IMAGES;
                    modelData.colors = ["Negro", "Gris", "Vino", "Verde Militar"];
                } else if (isLegging1) {
                    modelData.name = "Legging Ultra Seamless V1";
                    modelData.price = '85.00'; 
                    modelData.image = LEGGINGS_MODEL_1_IMAGES[0]; 
                    modelData.gallery = LEGGINGS_MODEL_1_IMAGES;
                    modelData.colors = ["Negro", "Beige (Nude)", "Gris Oscuro", "Azul Marino", "Vino (Borgoña)"];
                }
                
                return modelData;
            });
            return acc;
        }, {});

        // Obtener todos los modelos en una lista plana para la categoría "Todas"
        const ALL_MODELS = Object.values(CATALOG_DATA_MODELS).flat();

        // --- ESTADO DE LA APLICACIÓN Y CARRITO ---
        let currentCategory = null;
        let currentModel = null;
        // Para modelos sin color, esto se actualizará a "Modelo Único"
        let selectedColor = null; 
        let cart = []; 

        // --- REFERENCIAS DOM ---
        const categoryView = document.getElementById('category-view');
        const productListView = document.getElementById('product-list-view');
        const productDetailView = document.getElementById('product-detail-view');
        const cartView = document.getElementById('cart-view');
        const categoriesContainer = document.getElementById('category-view');
        const modelsContainer = document.getElementById('models-container');
        const categoryTitle = document.getElementById('current-category-title');
        const cartCountSpan = document.getElementById('cart-count');
        const toastContainer = document.getElementById('toast-container');
        
        // Detalle del producto
        const form = document.getElementById('order-form');
        const colorSelect = document.getElementById('selected-color');
        const colorSelectorGroup = document.getElementById('color-selector-group'); // Nuevo ID
        const quantityInput = document.getElementById('selected-quantity');
        const detailImage = document.getElementById('detail-main-image');
        const detailModelName = document.getElementById('detail-model-name');
        const detailCategoryName = document.getElementById('detail-category-name');
        const detailPrice = document.getElementById('detail-price');
        const addToCartBtn = document.getElementById('add-to-cart-btn');
        const validationMessage = document.getElementById('validation-message');
        const detailThumbnails = document.getElementById('detail-thumbnails');
        
        // Elementos LLM de Carrito
        const cartItemsContainer = document.getElementById('cart-items-container');
        const cartTotalItems = document.getElementById('cart-total-items');
        const whatsappOrderBtn = document.getElementById('whatsapp-order-btn');
        const outfitIdeasBtn = document.getElementById('outfit-ideas-btn');
        const outfitLoading = document.getElementById('outfit-loading');
        const outfitIdeasOutput = document.getElementById('outfit-ideas-output');


        // --- UTILIDADES ---

        /**
         * Muestra un mensaje temporal tipo "toast".
         * @param {string} message - El mensaje a mostrar.
         * @param {string} type - 'success' o 'error'.
         */
        function showToast(message, type = 'success') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500'
            };
            
            const toast = document.createElement('div');
            toast.className = `p-3 mb-2 ${colors[type]} text-white rounded-lg shadow-xl opacity-0 transform translate-y-2 transition-all duration-300`;
            toast.textContent = message;
            
            toastContainer.appendChild(toast);

            // Animación de entrada
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-y-2');
            }, 10);
            
            // Animación de salida y remoción
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        /**
         * Realiza la llamada a la API de Gemini con reintentos (exponential backoff).
         * @param {object} payload - El cuerpo de la solicitud de la API.
         * @param {number} maxRetries - Número máximo de reintentos.
         * @param {number} delay - Retraso inicial en ms.
         * @returns {Promise<string>} El texto generado por el LLM.
         */
        async function fetchGemini(payload, maxRetries = 3, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // Si es un error 429 (Too Many Requests) o 500/503, reintenta
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`API Error: ${response.statusText}`, { status: response.status });
                        }
                        // Otros errores (400, 403, etc.) se lanzan sin reintentar
                        const errorBody = await response.json();
                        throw new Error(`API Request Failed: ${JSON.stringify(errorBody)}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!text) {
                        throw new Error('Respuesta del LLM vacía o mal formada.');
                    }
                    return text;

                } catch (error) {
                    // console.error(`Intento ${i + 1} fallido:`, error);
                    if (i < maxRetries - 1) {
                        // console.log(`Reintentando en ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Duplicar el retraso
                    } else {
                        // Último intento fallido
                        throw new Error('No se pudo obtener la respuesta del Asistente (Gemini API agotó los reintentos).');
                    }
                }
            }
        }

        // --- FUNCIONES LLM DE OUTFIT (Mantenida) ---

        async function getOutfitIdeas() {
            if (cart.length === 0) return;

            outfitIdeasOutput.classList.add('hidden');
            outfitIdeasOutput.innerHTML = '';
            outfitIdeasBtn.disabled = true;
            outfitLoading.classList.remove('hidden');

            // Formatear el carrito para el prompt
            const cartItems = cart.map(item => 
                `${item.quantity}x ${item.name} (Color: ${item.color}, Categoría: ${item.category})`
            ).join('; ');

            const userQuery = `Eres un estilista personal virtual. El cliente tiene los siguientes artículos en su carrito: ${cartItems}. Genera 3 ideas de outfit diferentes. Cada idea debe incorporar al menos un artículo del carrito y sugerir 2 o 3 piezas complementarias (que no están en el carrito, como zapatillas, accesorios, o una chaqueta) para crear un look completo. Usa el siguiente formato para cada idea: *Idea #: [Nombre Corto del Look]*\n[Descripción de la combinación].`;
            
            const systemPrompt = "Actúa como un estilista de ropa deportiva que busca maximizar el potencial de las prendas seamless. Usa un tono moderno, juvenil y enfocado en la versatilidad de las piezas. Tu respuesta debe estar en español y ser fácil de leer con formato Markdown (negritas, saltos de línea).";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const text = await fetchGemini(payload);
                outfitIdeasOutput.innerHTML = `<div class="llm-output">${text}</div>`;
            } catch (error) {
                // console.error(error);
                outfitIdeasOutput.innerHTML = `<div class="llm-output text-red-700">❌ Error al generar ideas de outfit: ${error.message}</div>`;
                showToast('Error al conectar con el Estilista (Gemini API).', 'error');
            } finally {
                outfitIdeasOutput.classList.remove('hidden');
                outfitIdeasBtn.disabled = false;
                outfitLoading.classList.add('hidden');
            }
        }


        // --- FUNCIONES DE NAVEGACIÓN ---

        function updateView(viewId) {
            categoryView.classList.add('hidden');
            productListView.classList.add('hidden');
            productDetailView.classList.add('hidden');
            cartView.classList.add('hidden');
            
            if (viewId === 'category-view') {
                categoryView.classList.remove('hidden');
            } else if (viewId === 'product-list-view') {
                productListView.classList.remove('hidden');
            } else if (viewId === 'product-detail-view') {
                productDetailView.classList.remove('hidden');
            } else if (viewId === 'cart-view') {
                cartView.classList.remove('hidden');
            }
        }
        
        /**
         * Vuelve a la vista de categorías (Home).
         */
        function goBackToCategories() {
            currentCategory = null;
            currentModel = null;
            updateView('category-view');
        }

        /**
         * Vuelve a la vista de la lista de productos de la categoría actual.
         */
        function goBackToProducts() {
            currentModel = null;
            if (currentCategory) {
                 renderProductList(currentCategory);
            } else {
                // Si por alguna razón no hay categoría, vuelve a categorías
                goBackToCategories(); 
            }
        }
        
        function renderCartView() {
            // Ocultar resultados LLM al entrar al carrito
            outfitIdeasOutput.classList.add('hidden');
            outfitIdeasOutput.innerHTML = '';
            
            renderCartItems();
            updateView('cart-view');
        }

        // --- RENDERIZADO DE CATEGORÍAS ---

        function renderCategories() {
            categoriesContainer.innerHTML = '';
            
            const allCategories = ["Todas", ...BASE_CATEGORY_NAMES];

            allCategories.forEach(category => {
                const button = document.createElement('div');
                button.className = 'w-full p-4 bg-gray-50 rounded-xl shadow-md transition duration-200 hover:bg-blue-50 hover:shadow-lg cursor-pointer text-center';
                button.innerHTML = `<span class="text-lg font-semibold text-gray-700">${category}</span>`;
                button.onclick = () => renderProductList(category);
                categoriesContainer.appendChild(button);
            });
            updateView('category-view');
        }

        // --- RENDERIZADO DE LISTA DE PRODUCTOS ---

        function renderProductList(category) {
            currentCategory = category;
            categoryTitle.textContent = category;
            modelsContainer.innerHTML = '';

            const modelsToDisplay = category === "Todas" 
                ? ALL_MODELS
                : CATALOG_DATA_MODELS[category];

            if (!modelsToDisplay || modelsToDisplay.length === 0) {
                 modelsContainer.innerHTML = '<p class="text-center text-gray-500 col-span-2 p-8 border rounded-lg">No hay modelos disponibles en esta categoría.</p>';
            }

            modelsToDisplay.forEach(model => {
                const productCard = document.createElement('div');
                productCard.className = 'bg-white rounded-xl shadow-lg border border-gray-100 p-2 overflow-hidden cursor-pointer hover:shadow-xl transition duration-300';
                
                const colorInfo = model.colors && model.colors.length > 0 
                    ? `Colores: ${model.colors.length}` 
                    : 'Color Único';

                // Usamos el placeholder negro si la imagen principal falla
                productCard.innerHTML = `
                    <img src="${model.image}" alt="${model.name}" onerror="this.onerror=null; this.src='https://placehold.co/300x400/000000/ffffff?text=No+Photo';" class="w-full h-48 object-cover rounded-lg mb-2 transform hover:scale-105 transition duration-300">
                    <h3 class="font-semibold text-gray-800 text-sm truncate">${model.name}</h3>
                    <p class="text-xs text-gray-500">${colorInfo}</p>
                    <p class="text-lg font-bold text-blue-600 mt-1">$${model.price} MXN</p>
                    <button class="w-full mt-2 text-xs py-1.5 bg-blue-50 text-blue-600 rounded-md font-medium">Ver Modelo</button>
                `;
                productCard.onclick = () => renderProductDetail(category, model);
                modelsContainer.appendChild(productCard);
            });

            updateView('product-list-view');
        }

        // --- RENDERIZADO DEL DETALLE DEL PRODUCTO ---

        function renderProductDetail(category, model) {
            currentModel = model;
            
            // 1. Actualizar información del modelo
            detailModelName.textContent = model.name;
            detailCategoryName.textContent = `Categoría: ${category === "Todas" ? 'Varios' : category}`;
            detailPrice.textContent = `$${model.price} MXN`;
            
            // 2. Renderizar Galería (Miniaturas y Principal)
            detailThumbnails.innerHTML = '';
            
            const images = model.gallery;

            // Establece la primera imagen como principal. Usa placeholder negro en error.
            detailImage.src = images[0]; 
            detailImage.onerror = function() { this.onerror=null; this.src='https://placehold.co/400x500/000000/ffffff?text=Error+Loading+Image'; };

            // Renderizar miniaturas solo si hay más de una imagen.
            if (images.length > 1) {
                detailThumbnails.classList.remove('hidden');
                images.forEach((imgUrl, index) => {
                    const thumbnail = document.createElement('img');
                    thumbnail.src = imgUrl;
                    thumbnail.alt = `Foto ${index + 1} de ${model.name}`;
                    thumbnail.className = `w-full h-auto object-cover rounded-lg opacity-80 hover:opacity-100 cursor-pointer border-2 border-transparent transition duration-150`;
                    
                    if (index === 0) {
                        thumbnail.classList.add('thumbnail-active'); // Marca la primera como activa
                    }

                    thumbnail.onclick = () => {
                        // Cambiar la imagen principal
                        detailImage.src = imgUrl;
                        detailImage.onerror = function() { this.onerror=null; this.src='https://placehold.co/400x500/000000/ffffff?text=Error+Loading+Image'; }; // Placeholder negro en error
                        // Actualizar estado activo de la miniatura
                        document.querySelectorAll('#detail-thumbnails img').forEach(t => t.classList.remove('thumbnail-active'));
                        thumbnail.classList.add('thumbnail-active');
                    };
                    detailThumbnails.appendChild(thumbnail);
                });
            } else {
                detailThumbnails.classList.add('hidden');
            }
            
            // 3. Manejar Colores y Formulario
            const requiresColor = model.colors && model.colors.length > 0;
            
            if (requiresColor) {
                // Mostrar selector de color
                colorSelectorGroup.classList.remove('hidden');
                validationMessage.textContent = 'Selecciona Color para añadir al carrito.';
                
                colorSelect.innerHTML = '<option value="" disabled selected>-- Elige un color --</option>';
                model.colors.forEach(color => {
                    const option = document.createElement('option');
                    option.value = color;
                    option.textContent = color;
                    colorSelect.appendChild(option);
                });
                selectedColor = null; // Reiniciar
            } else {
                // Ocultar selector de color y usar un valor predeterminado
                colorSelectorGroup.classList.add('hidden');
                validationMessage.textContent = 'Añade la cantidad para confirmar.';
                selectedColor = "Modelo Único"; // Valor de color por defecto para el carrito
            }
            
            // 4. Resetear cantidad y estado del botón
            quantityInput.value = 1;
            checkFormValidity();

            updateView('product-detail-view');
        }

        // --- LÓGICA DEL CARRITO ---

        colorSelect.addEventListener('change', (e) => {
            // Solo se ejecuta si el selector de color está visible
            selectedColor = e.target.value;
            checkFormValidity();
        });

        // Habilitar/Deshabilitar botón de Añadir al Carrito
        function checkFormValidity() {
            if (!currentModel) return;

            const requiresColor = currentModel.colors && currentModel.colors.length > 0;
            let isValid = true;
            
            if (requiresColor) {
                // Si el color es requerido, es válido si se ha seleccionado algo diferente a null
                isValid = !!selectedColor; 
            } else {
                // Si el color NO es requerido (como Enterizos), es válido por defecto
                isValid = true;
            }

            if (isValid) {
                addToCartBtn.disabled = false;
                addToCartBtn.classList.remove('opacity-50');
                validationMessage.classList.add('hidden');
            } else {
                addToCartBtn.disabled = true;
                addToCartBtn.classList.add('opacity-50');
                validationMessage.classList.remove('hidden');
            }
        }
        
        // Listener para añadir al carrito
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            if (!currentModel || !checkFormValidity()) return;
            
            const requiresColor = currentModel.colors && currentModel.colors.length > 0;
            const finalColor = requiresColor ? selectedColor : "Modelo Único";
            
            const quantity = parseInt(quantityInput.value);
            
            const newItem = {
                // Generar un ID único para el item del carrito
                cartId: Date.now() + Math.random(), 
                id: currentModel.id,
                name: currentModel.name,
                category: detailCategoryName.textContent.replace('Categoría: ', ''),
                price: parseFloat(currentModel.price),
                color: finalColor, // Usar el color final
                quantity: quantity,
                image: currentModel.image // Guardar la URL de la imagen principal para el carrito
            };
            
            cart.push(newItem);
            
            // Resetear y volver a la vista de productos con un mensaje de éxito
            form.reset();
            currentModel = null;
            selectedColor = null; // Asegurar que se reinicie
            updateCartCount();
            
            // Mostrar mensaje temporal de éxito (toast)
            showToast(`✅ ¡${newItem.quantity}x ${newItem.name} añadido al carrito!`, 'success');
            
            setTimeout(() => {
                renderProductList(currentCategory); // Volver a la lista después de añadir
            }, 1000); 
        });

        function updateCartCount() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCountSpan.textContent = totalItems;

            if (totalItems > 0) {
                cartCountSpan.classList.remove('hidden');
                whatsappOrderBtn.disabled = false;
                whatsappOrderBtn.classList.remove('opacity-50');
                outfitIdeasBtn.disabled = false; // Habilitar botón de ideas de outfit
            } else {
                cartCountSpan.classList.add('hidden');
                whatsappOrderBtn.disabled = true;
                whatsappOrderBtn.classList.add('opacity-50');
                outfitIdeasBtn.disabled = true; // Deshabilitar botón de ideas de outfit
            }
        }
        
        // --- RENDERIZADO DE ITEMS DEL CARRITO ---
        
        function removeItemFromCart(cartId) {
            cart = cart.filter(item => item.cartId !== cartId);
            renderCartItems();
            updateCartCount();
            // Ocultar LLM output al cambiar el carrito
            outfitIdeasOutput.classList.add('hidden');
            outfitIdeasOutput.innerHTML = '';
        }

        function renderCartItems() {
            cartItemsContainer.innerHTML = '';
            let totalItems = 0;
            
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-center text-gray-500 p-8 border rounded-lg">El carrito está vacío. ¡Añade algunos modelos!</p>';
            } else {
                cart.forEach(item => {
                    totalItems += item.quantity;
                    const itemTotal = (item.price * item.quantity).toFixed(2);

                    const cartItemDiv = document.createElement('div');
                    cartItemDiv.className = 'flex items-center space-x-3 p-3 bg-gray-50 rounded-lg shadow-sm border border-gray-200';
                    cartItemDiv.innerHTML = `
                        <img src="${item.image}" 
                             alt="${item.name}" 
                             onerror="this.onerror=null; this.src='https://placehold.co/80x80/94a3b8/ffffff?text=Item';"
                             class="w-16 h-16 object-cover rounded-md flex-shrink-0">
                        <div class="flex-grow">
                            <p class="font-bold text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-600">Color: ${item.color} | Cantidad: ${item.quantity}</p>
                            <p class="text-md font-semibold text-blue-600">$${itemTotal} MXN</p>
                        </div>
                        <button onclick="removeItemFromCart(${item.cartId})" 
                                class="text-red-500 hover:text-red-700 font-semibold text-sm flex-shrink-0 p-1">
                            Eliminar
                        </button>
                    `;
                    cartItemsContainer.appendChild(cartItemDiv);
                });
            }

            cartTotalItems.textContent = totalItems;
            updateCartCount();
        }
        
        // --- FUNCIÓN DE WHATSAPP FINAL ---
        
        function sendWhatsAppOrder() {
            if (cart.length === 0) return;

            let orderSummary = "¡Hola! Me gustaría hacer un pedido de los siguientes modelos Seamless:\n\n";
            let grandTotal = 0;
            let totalItems = 0;

            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                grandTotal += itemTotal;
                totalItems += item.quantity;
                
                orderSummary += `*${index + 1}. ${item.name}*\n`;
                orderSummary += `   - Categoría: ${item.category}\n`;
                orderSummary += `   - Color: ${item.color}\n`;
                orderSummary += `   - Cantidad: ${item.quantity} unidades\n`;
                orderSummary += `   - Precio Unitario: $${item.price} MXN\n`;
                orderSummary += `   - Subtotal: $${itemTotal.toFixed(2)} MXN\n\n`;
            });

            orderSummary += "--------------------------------------\n";
            orderSummary += `*TOTAL DE ARTÍCULOS:* ${totalItems}\n`;
            orderSummary += `*GRAN TOTAL ESTIMADO:* $${grandTotal.toFixed(2)} MXN\n\n`;
            orderSummary += "Por favor, confirmen disponibilidad y costo total. ¡Gracias!";


            // Codificar el mensaje para la URL
            const encodedMessage = encodeURIComponent(orderSummary);
            
            // Generar el enlace de WhatsApp
            const whatsappLink = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodedMessage}`;

            // Redirigir al usuario
            window.open(whatsappLink, '_blank');
        }

        // --- INICIALIZACIÓN ---
        window.onload = renderCategories;

    </script>
</body>
</html>
